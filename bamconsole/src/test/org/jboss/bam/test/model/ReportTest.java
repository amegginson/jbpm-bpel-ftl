package org.jboss.bam.test.model;

import java.util.ArrayList;

import org.hibernate.Session;
import org.hibernate.Transaction;
import org.hibernate.exception.SQLGrammarException;
import org.jboss.bam.report.JasperReport;
import org.jboss.bam.report.SubJasperReport;

public class ReportTest extends TestCase {

	public ReportTest(String x) {
		super(x);
	}

	/**
	 * Test saving a jasper report
	 * 
	 * @throws Exception
	 */
	public void testJasperReport() throws Exception {
		Session s;
		Transaction tx;
		s = openSession();
		tx = s.beginTransaction();
		JasperReport report = new JasperReport();
		// Create report
		report.setName("rpt-01");
		report.setDescription("Report description");
		String reportFileByte = "3c3f786d6c2076657273696f6e3d22312e302220656e636f64696e673d225554462d382220203f3e0a3c212d2d2043726561746564207769746820695265706f7274202d20412064657369676e657220666f72204a61737065725265706f727473202d2d3e0a3c21444f4354595045206a61737065725265706f7274205055424c494320222f2f4a61737065725265706f7274732f2f445444205265706f72742044657369676e2f2f454e222022687474703a2f2f6a61737065727265706f7274732e736f75726365666f7267652e6e65742f647464732f6a61737065727265706f72742e647464223e0a3c6a61737065725265706f72740a0909206e616d653d2250726f636573735265706f7274220a090920636f6c756d6e436f756e743d2231220a0909207072696e744f726465723d22566572746963616c220a0909206f7269656e746174696f6e3d22506f727472616974220a0909207061676557696474683d22353935220a090920706167654865696768743d22383432220a090920636f6c756d6e57696474683d22353335220a090920636f6c756d6e53706163696e673d2230220a0909206c6566744d617267696e3d223330220a09092072696768744d617267696e3d223330220a090920746f704d617267696e3d223230220a090920626f74746f6d4d617267696e3d223230220a0909207768656e4e6f44617461547970653d224e6f5061676573220a09092069735469746c654e6577506167653d2266616c7365220a090920697353756d6d6172794e6577506167653d2266616c7365223e0a093c70726f7065727479206e616d653d22697265706f72742e7363726970746c657468616e646c696e67222076616c75653d223022202f3e0a093c70726f7065727479206e616d653d22697265706f72742e656e636f64696e67222076616c75653d225554462d3822202f3e0a093c696d706f72742076616c75653d226a6176612e7574696c2e2a22202f3e0a093c696d706f72742076616c75653d226e65742e73662e6a61737065727265706f7274732e656e67696e652e2a22202f3e0a093c696d706f72742076616c75653d226e65742e73662e6a61737065727265706f7274732e656e67696e652e646174612e2a22202f3e0a0a093c706172616d65746572206e616d653d225265706f72745469746c6522206973466f7250726f6d7074696e673d2266616c73652220636c6173733d226a6176612e6c616e672e537472696e67222f3e0a093c7175657279537472696e673e3c215b43444154415b73656c6563740a202020202020202070726f63657373646566315f2e4e414d455f2061732070726f635f6465665f6e616d652c0a2020202020202020636f756e742870726f63657373646566315f2e4e414d455f292070726f635f6465665f636f756e740a66726f6d0a20202020202020204a42504d5f50524f43455353494e5354414e43452070726f63657373696e73305f2c0a20202020202020204a42504d5f50524f43455353444546494e4954494f4e2070726f63657373646566315f200a77686572650a202020202020202070726f63657373696e73305f2e50524f43455353444546494e4954494f4e5f3d70726f63657373646566315f2e49445f200a67726f75702062790a202020202020202070726f63657373646566315f2e4e414d455f5d5d3e3c2f7175657279537472696e673e0a0a093c6669656c64206e616d653d2250524f435f4445465f434f554e542220636c6173733d226a6176612e6c616e672e496e7465676572222f3e0a093c6669656c64206e616d653d2250524f435f4445465f4e414d452220636c6173733d226a6176612e6c616e672e537472696e67222f3e0a0a09093c6261636b67726f756e643e0a0909093c62616e64206865696768743d2230222020697353706c6974416c6c6f7765643d227472756522203e0a0909093c2f62616e643e0a09093c2f6261636b67726f756e643e0a09093c7469746c653e0a0909093c62616e64206865696768743d223530222020697353706c6974416c6c6f7765643d227472756522203e0a090909093c737461746963546578743e0a09090909093c7265706f7274456c656d656e740a090909090909783d2236220a090909090909793d2239220a09090909090977696474683d22353234220a0909090909096865696768743d223331220a0909090909096b65793d22737461746963546578742d31222f3e0a09090909093c626f7820746f70426f726465723d224e6f6e652220746f70426f72646572436f6c6f723d222330303030303022206c656674426f726465723d224e6f6e6522206c656674426f72646572436f6c6f723d222330303030303022207269676874426f726465723d224e6f6e6522207269676874426f72646572436f6c6f723d22233030303030302220626f74746f6d426f726465723d224e6f6e652220626f74746f6d426f72646572436f6c6f723d2223303030303030222f3e0a09090909093c74657874456c656d656e742074657874416c69676e6d656e743d2243656e7465722220766572746963616c416c69676e6d656e743d224d6964646c65223e0a0909090909093c666f6e7420706466466f6e744e616d653d2248656c7665746963612d426f6c64222073697a653d22323022206973426f6c643d2274727565222f3e0a09090909093c2f74657874456c656d656e743e0a090909093c746578743e3c215b43444154415b50726f63657373205265706f7274735d5d3e3c2f746578743e0a090909093c2f737461746963546578743e0a0909093c2f62616e643e0a09093c2f7469746c653e0a09093c706167654865616465723e0a0909093c62616e64206865696768743d223530222020697353706c6974416c6c6f7765643d227472756522203e0a090909093c737461746963546578743e0a09090909093c7265706f7274456c656d656e740a090909090909783d2236220a090909090909793d2237220a09090909090977696474683d223538220a0909090909096865696768743d223230220a0909090909096b65793d22737461746963546578742d32222f3e0a09090909093c626f7820746f70426f726465723d224e6f6e652220746f70426f72646572436f6c6f723d222330303030303022206c656674426f726465723d224e6f6e6522206c656674426f72646572436f6c6f723d222330303030303022207269676874426f726465723d224e6f6e6522207269676874426f72646572436f6c6f723d22233030303030302220626f74746f6d426f726465723d224e6f6e652220626f74746f6d426f72646572436f6c6f723d2223303030303030222f3e0a09090909093c74657874456c656d656e743e0a0909090909093c666f6e7420706466466f6e744e616d653d2248656c7665746963612d426f6c64222073697a653d22313222206973426f6c643d227472756522206973556e6465726c696e653d2274727565222f3e0a09090909093c2f74657874456c656d656e743e0a090909093c746578743e3c215b43444154415b51756572795d5d3e3c2f746578743e0a090909093c2f737461746963546578743e0a090909093c746578744669656c6420697353747265746368576974684f766572666c6f773d2266616c736522206973426c616e6b5768656e4e756c6c3d2266616c736522206576616c756174696f6e54696d653d224e6f77222068797065726c696e6b547970653d224e6f6e6522202068797065726c696e6b5461726765743d2253656c6622203e0a09090909093c7265706f7274456c656d656e740a090909090909783d223634220a090909090909793d2237220a09090909090977696474683d22343636220a0909090909096865696768743d223230220a0909090909096b65793d22746578744669656c642d31222f3e0a09090909093c626f7820746f70426f726465723d224e6f6e652220746f70426f72646572436f6c6f723d222330303030303022206c656674426f726465723d224e6f6e6522206c656674426f72646572436f6c6f723d222330303030303022207269676874426f726465723d224e6f6e6522207269676874426f72646572436f6c6f723d22233030303030302220626f74746f6d426f726465723d224e6f6e652220626f74746f6d426f72646572436f6c6f723d2223303030303030222f3e0a09090909093c74657874456c656d656e743e0a0909090909093c666f6e7420706466466f6e744e616d653d2248656c7665746963612d426f6c64222073697a653d22313222206973426f6c643d2274727565222f3e0a09090909093c2f74657874456c656d656e743e0a090909093c746578744669656c6445787072657373696f6e202020636c6173733d226a6176612e6c616e672e537472696e67223e3c215b43444154415b24507b5265706f72745469746c657d5d5d3e3c2f746578744669656c6445787072657373696f6e3e0a090909093c2f746578744669656c643e0a0909093c2f62616e643e0a09093c2f706167654865616465723e0a09093c636f6c756d6e4865616465723e0a0909093c62616e64206865696768743d223330222020697353706c6974416c6c6f7765643d227472756522203e0a090909093c737461746963546578743e0a09090909093c7265706f7274456c656d656e740a090909090909783d223136220a090909090909793d2230220a09090909090977696474683d22313135220a0909090909096865696768743d223238220a0909090909096b65793d22737461746963546578742d33222f3e0a09090909093c626f7820746f70426f726465723d224e6f6e652220746f70426f72646572436f6c6f723d222330303030303022206c656674426f726465723d224e6f6e6522206c656674426f72646572436f6c6f723d222330303030303022207269676874426f726465723d224e6f6e6522207269676874426f72646572436f6c6f723d22233030303030302220626f74746f6d426f726465723d224e6f6e652220626f74746f6d426f72646572436f6c6f723d2223303030303030222f3e0a09090909093c74657874456c656d656e743e0a0909090909093c666f6e7420706466466f6e744e616d653d2248656c7665746963612d426f6c6422206973426f6c643d2274727565222f3e0a09090909093c2f74657874456c656d656e743e0a090909093c746578743e3c215b43444154415b50726f6365737320446566696e6974696f6e5d5d3e3c2f746578743e0a090909093c2f737461746963546578743e0a090909093c737461746963546578743e0a09090909093c7265706f7274456c656d656e740a090909090909783d22313331220a090909090909793d2230220a09090909090977696474683d223932220a0909090909096865696768743d223238220a0909090909096b65793d22737461746963546578742d34222f3e0a09090909093c626f7820746f70426f726465723d224e6f6e652220746f70426f72646572436f6c6f723d222330303030303022206c656674426f726465723d224e6f6e6522206c656674426f72646572436f6c6f723d222330303030303022207269676874426f726465723d224e6f6e6522207269676874426f72646572436f6c6f723d22233030303030302220626f74746f6d426f726465723d224e6f6e652220626f74746f6d426f72646572436f6c6f723d2223303030303030222f3e0a09090909093c74657874456c656d656e742074657874416c69676e6d656e743d2243656e746572223e0a0909090909093c666f6e7420706466466f6e744e616d653d2248656c7665746963612d426f6c6422206973426f6c643d2274727565222f3e0a09090909093c2f74657874456c656d656e743e0a090909093c746578743e3c215b43444154415b496e7374616e63657320436f756e745d5d3e3c2f746578743e0a090909093c2f737461746963546578743e0a090909093c6c696e6520646972656374696f6e3d22546f70446f776e223e0a09090909093c7265706f7274456c656d656e740a090909090909783d223136220a090909090909793d223238220a09090909090977696474683d22323037220a0909090909096865696768743d2230220a0909090909096b65793d226c696e652d31222f3e0a09090909093c67726170686963456c656d656e742073747265746368547970653d224e6f53747265746368222f3e0a090909093c2f6c696e653e0a0909093c2f62616e643e0a09093c2f636f6c756d6e4865616465723e0a09093c64657461696c3e0a0909093c62616e64206865696768743d223432222020697353706c6974416c6c6f7765643d227472756522203e0a090909093c746578744669656c6420697353747265746368576974684f766572666c6f773d2266616c736522206973426c616e6b5768656e4e756c6c3d2266616c736522206576616c756174696f6e54696d653d224e6f77222068797065726c696e6b547970653d224e6f6e6522202068797065726c696e6b5461726765743d2253656c6622203e0a09090909093c7265706f7274456c656d656e740a090909090909783d22313331220a090909090909793d223133220a09090909090977696474683d223932220a0909090909096865696768743d223138220a0909090909096b65793d22746578744669656c64222f3e0a09090909093c626f7820746f70426f726465723d224e6f6e652220746f70426f72646572436f6c6f723d222330303030303022206c656674426f726465723d224e6f6e6522206c656674426f72646572436f6c6f723d222330303030303022207269676874426f726465723d224e6f6e6522207269676874426f72646572436f6c6f723d22233030303030302220626f74746f6d426f726465723d224e6f6e652220626f74746f6d426f72646572436f6c6f723d2223303030303030222f3e0a09090909093c74657874456c656d656e743e0a0909090909093c666f6e742f3e0a09090909093c2f74657874456c656d656e743e0a090909093c746578744669656c6445787072657373696f6e202020636c6173733d226a6176612e6c616e672e496e7465676572223e3c215b43444154415b24467b50524f435f4445465f434f554e547d5d5d3e3c2f746578744669656c6445787072657373696f6e3e0a090909093c2f746578744669656c643e0a090909093c746578744669656c6420697353747265746368576974684f766572666c6f773d2266616c736522206973426c616e6b5768656e4e756c6c3d2266616c736522206576616c756174696f6e54696d653d224e6f77222068797065726c696e6b547970653d224e6f6e6522202068797065726c696e6b5461726765743d2253656c6622203e0a09090909093c7265706f7274456c656d656e740a090909090909783d223136220a090909090909793d223133220a09090909090977696474683d22313135220a0909090909096865696768743d223138220a0909090909096b65793d22746578744669656c64222f3e0a09090909093c626f7820746f70426f726465723d224e6f6e652220746f70426f72646572436f6c6f723d222330303030303022206c656674426f726465723d224e6f6e6522206c656674426f72646572436f6c6f723d222330303030303022207269676874426f726465723d224e6f6e6522207269676874426f72646572436f6c6f723d22233030303030302220626f74746f6d426f726465723d224e6f6e652220626f74746f6d426f72646572436f6c6f723d2223303030303030222f3e0a09090909093c74657874456c656d656e743e0a0909090909093c666f6e742f3e0a09090909093c2f74657874456c656d656e743e0a090909093c746578744669656c6445787072657373696f6e202020636c6173733d226a6176612e6c616e672e537472696e67223e3c215b43444154415b24467b50524f435f4445465f4e414d457d5d5d3e3c2f746578744669656c6445787072657373696f6e3e0a090909093c2f746578744669656c643e0a0909093c2f62616e643e0a09093c2f64657461696c3e0a09093c636f6c756d6e466f6f7465723e0a0909093c62616e64206865696768743d223330222020697353706c6974416c6c6f7765643d227472756522203e0a0909093c2f62616e643e0a09093c2f636f6c756d6e466f6f7465723e0a09093c70616765466f6f7465723e0a0909093c62616e64206865696768743d223530222020697353706c6974416c6c6f7765643d227472756522203e0a090909093c746578744669656c6420697353747265746368576974684f766572666c6f773d2266616c736522206973426c616e6b5768656e4e756c6c3d2266616c736522206576616c756174696f6e54696d653d224e6f77222068797065726c696e6b547970653d224e6f6e6522202068797065726c696e6b5461726765743d2253656c6622203e0a09090909093c7265706f7274456c656d656e740a090909090909783d22343333220a090909090909793d223239220a09090909090977696474683d22313030220a0909090909096865696768743d223138220a0909090909096b65793d22746578744669656c64222f3e0a09090909093c626f7820746f70426f726465723d224e6f6e652220746f70426f72646572436f6c6f723d222330303030303022206c656674426f726465723d224e6f6e6522206c656674426f72646572436f6c6f723d222330303030303022207269676874426f726465723d224e6f6e6522207269676874426f72646572436f6c6f723d22233030303030302220626f74746f6d426f726465723d224e6f6e652220626f74746f6d426f72646572436f6c6f723d2223303030303030222f3e0a09090909093c74657874456c656d656e743e0a0909090909093c666f6e742f3e0a09090909093c2f74657874456c656d656e743e0a090909093c746578744669656c6445787072657373696f6e202020636c6173733d226a6176612e6c616e672e496e7465676572223e3c215b43444154415b24567b504147455f4e554d4245527d5d5d3e3c2f746578744669656c6445787072657373696f6e3e0a090909093c2f746578744669656c643e0a0909093c2f62616e643e0a09093c2f70616765466f6f7465723e0a09093c6c61737450616765466f6f7465723e0a0909093c62616e64206865696768743d223530222020697353706c6974416c6c6f7765643d227472756522203e0a0909093c2f62616e643e0a09093c2f6c61737450616765466f6f7465723e0a09093c73756d6d6172793e0a0909093c62616e64206865696768743d223530222020697353706c6974416c6c6f7765643d227472756522203e0a0909093c2f62616e643e0a09093c2f73756d6d6172793e0a3c2f6a61737065725265706f72743e0a";
		report.setReportFile(reportFileByte.getBytes());

		// Add a subreport
		//		

		// Save report into the database
		s.persist(report);
		// Save the sub report into the database
		// s.persist(subReport);
		SubJasperReport subReport = new SubJasperReport();
		subReport.setSubReportFile(reportFileByte.getBytes());
		subReport.setReport(report);
		// Add a sub report to the main report
		ArrayList<SubJasperReport> subReports = new ArrayList<SubJasperReport>();
		subReports.add(subReport);
		report.setSubReports(subReports);
		s.update(report);

		// load report from the database
		JasperReport retrievedReport = (JasperReport) s.createQuery(
				"from JasperReport report").list().get(0);
		assertEquals(retrievedReport, report);
		SubJasperReport retrievedSubReport = retrievedReport.getSubReports().get(0);
		assertEquals(retrievedSubReport, subReport);
		assertEquals(retrievedSubReport.getReport(), report);
		try {
			tx.commit();
		} catch (SQLGrammarException e) {
			System.err.println(e.getSQLException().getNextException());
			throw e;
		}
		s.close();
	}

	/**
	 * Return the defined mappings of the objects.
	 * 
	 * @see org.jboss.jbam.test.model.TestCase#getMappings()
	 */
	protected Class<?>[] getMappings() {
		return new Class[] { JasperReport.class, SubJasperReport.class };
	}

}
